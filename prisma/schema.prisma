// Prisma schema for HRM8 Authentication System

generator client {
  provider = "prisma-client-js"
}

// The `url` property in datasource is deprecated and should be configured externally per Prisma 5+ requirements.
// See: https://pris.ly/d/config-datasource and https://pris.ly/d/prisma7-client-config

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Required for prisma generate validation, but actual connection uses prisma.config.ts
  // Connection URL is now configured in prisma.config.ts or passed to the PrismaClient constructor.
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER
  VISITOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING_VERIFICATION
  INVITED
}

enum CompanyVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum CompanyProfileStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum CompanyProfileSection {
  BASIC_DETAILS
  PRIMARY_LOCATION
  PERSONAL_PROFILE
  TEAM_MEMBERS
  BILLING
  BRANDING
}

enum VerificationMethod {
  EMAIL_DOMAIN_CHECK
  VERIFICATION_EMAIL
  MANUAL_VERIFICATION
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum SignupRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum JobStatus {
  DRAFT
  OPEN
  CLOSED
  ON_HOLD
  FILLED
}

enum HiringMode {
  SELF_MANAGED
  SHORTLISTING
  FULL_SERVICE
  EXECUTIVE_SEARCH
}

enum WorkArrangement {
  ON_SITE
  REMOTE
  HYBRID
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  CASUAL
}

model Company {
  id                String                    @id @default(uuid())
  name              String
  website           String
  domain            String                    @unique // Extracted from website (e.g., "tata.com")
  countryOrRegion   String                    @map("country_or_region") @default("")
  acceptedTerms     Boolean                   @map("accepted_terms") @default(false)
  verificationStatus CompanyVerificationStatus @default(PENDING)
  verificationMethod VerificationMethod?
  
  // Verification data fields
  verifiedAt        DateTime?
  verifiedBy        String?
  gstNumber         String?
  registrationNumber String?
  linkedInUrl       String?
  
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  
  // Relations
  users             User[]
  invitations       Invitation[]
  verificationTokens VerificationToken[]
  signupRequests    SignupRequest[]
  profile           CompanyProfile?
  jobs              Job[]
  
  @@index([domain])
  @@index([verificationStatus])
}

model CompanyProfile {
  id                   String                 @id @default(uuid())
  companyId            String                 @unique @map("company_id")
  status               CompanyProfileStatus   @default(NOT_STARTED)
  completionPercentage Int                    @default(0) @map("completion_percentage")
  completedSections    CompanyProfileSection[] @default([]) @map("completed_sections")
  profileData          Json?                  @map("profile_data")
  lastReminderAt       DateTime?              @map("last_reminder_at")
  skipUntil            DateTime?              @map("skip_until")
  createdAt            DateTime               @default(now()) @map("created_at")
  updatedAt            DateTime               @updatedAt @map("updated_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model User {
  id            String      @id @default(uuid())
  email         String      @unique
  name          String
  passwordHash  String      @map("password_hash")
  companyId     String      @map("company_id")
  role          UserRole
  status        UserStatus  @default(PENDING_VERIFICATION)
  assignedBy    String?     @map("assigned_by") // User ID who assigned this role
  lastLoginAt   DateTime?   @map("last_login_at")
  
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  // Relations
  company       Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sentInvitations Invitation[] @relation("InvitedBy")
  sessions      Session[]
  reviewedSignupRequests SignupRequest[] @relation("ReviewedBy")
  roleAssigner  User?       @relation("RoleAssigner", fields: [assignedBy], references: [id], onDelete: SetNull)
  assignedUsers User[]      @relation("RoleAssigner")
  createdJobs   Job[]       @relation("JobCreator")
  
  @@index([email])
  @@index([companyId])
  @@index([status])
  @@index([role])
}

model Invitation {
  id          String           @id @default(uuid())
  companyId   String           @map("company_id")
  invitedBy   String           @map("invited_by")
  email       String
  token       String           @unique
  status      InvitationStatus @default(PENDING)
  expiresAt   DateTime         @map("expires_at")
  acceptedAt  DateTime?        @map("accepted_at")
  
  createdAt   DateTime         @default(now()) @map("created_at")
  
  // Relations
  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  inviter     User             @relation("InvitedBy", fields: [invitedBy], references: [id], onDelete: Cascade)
  
  @@index([email])
  @@index([companyId])
  @@index([token])
  @@index([status])
  @@index([expiresAt])
}

model Session {
  id          String   @id @default(uuid())
  sessionId   String   @unique @map("session_id")
  userId      String   @map("user_id")
  companyId   String   @map("company_id")
  userRole    UserRole @map("user_role")
  email       String
  expiresAt   DateTime @map("expires_at")
  lastActivity DateTime @default(now()) @map("last_activity")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([userId])
  @@index([companyId])
  @@index([expiresAt])
}

model VerificationToken {
  id          String   @id @default(uuid())
  companyId   String   @map("company_id")
  email       String
  token       String   @unique
  expiresAt   DateTime @map("expires_at")
  usedAt      DateTime? @map("used_at")
  
  createdAt   DateTime @default(now()) @map("created_at")
  
  // Relations
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([email])
  @@index([token])
  @@index([expiresAt])
}

model SignupRequest {
  id          String              @id @default(uuid())
  companyId   String              @map("company_id")
  email       String
  name        String
  firstName   String              @map("first_name") @default("")
  lastName    String              @map("last_name") @default("")
  acceptedTerms Boolean           @map("accepted_terms") @default(false)
  passwordHash String              @map("password_hash")
  status      SignupRequestStatus @default(PENDING)
  reviewedBy  String?             @map("reviewed_by")
  reviewedAt  DateTime?           @map("reviewed_at")
  rejectionReason String?         @map("rejection_reason")
  
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")
  
  // Relations
  company     Company             @relation(fields: [companyId], references: [id], onDelete: Cascade)
  reviewer    User?              @relation("ReviewedBy", fields: [reviewedBy], references: [id], onDelete: SetNull)
  
  @@index([email])
  @@index([companyId])
  @@index([status])
  @@index([createdAt])
}

model Job {
  id                String          @id @default(uuid())
  companyId         String          @map("company_id")
  createdBy         String          @map("created_by")
  jobCode           String?         @map("job_code")
  title             String
  description       String          @db.Text
  jobSummary        String?         @map("job_summary") @db.VarChar(150)
  status            JobStatus       @default(DRAFT)
  hiringMode        HiringMode      @default(SELF_MANAGED) @map("hiring_mode")
  
  // Location & Department
  location          String
  department        String?
  workArrangement   WorkArrangement @default(ON_SITE) @map("work_arrangement")
  
  // Employment Details
  employmentType    EmploymentType @default(FULL_TIME) @map("employment_type")
  numberOfVacancies Int            @default(1) @map("number_of_vacancies")
  
  // Salary Information
  salaryMin         Float?          @map("salary_min")
  salaryMax         Float?          @map("salary_max")
  salaryCurrency    String          @default("USD") @map("salary_currency")
  salaryDescription String?         @map("salary_description") @db.Text
  
  // Job Details
  category          String?
  promotionalTags  String[]        @default([]) @map("promotional_tags")
  featured          Boolean         @default(false)
  stealth           Boolean         @default(false) // Confidential/stealth mode
  visibility        String          @default("public") // public or private
  
  // Requirements and Responsibilities
  requirements      String[]        @default([])
  responsibilities  String[]        @default([])
  
  // Terms Acceptance
  termsAccepted     Boolean         @default(false) @map("terms_accepted")
  termsAcceptedAt   DateTime?       @map("terms_accepted_at")
  termsAcceptedBy   String?         @map("terms_accepted_by")
  
  // Dates
  postingDate       DateTime?       @map("posting_date")
  expiryDate        DateTime?       @map("expiry_date")
  closeDate         DateTime?       @map("close_date")
  
  // Hiring Team
  hiringTeam        Json?           @map("hiring_team")
  
  // Application Form Configuration
  applicationForm   Json?           @map("application_form")
  
  createdAt         DateTime        @default(now()) @map("created_at")
  updatedAt         DateTime        @updatedAt @map("updated_at")
  
  // Relations
  company           Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  creator           User            @relation("JobCreator", fields: [createdBy], references: [id], onDelete: Cascade)
  
  @@index([companyId])
  @@index([createdBy])
  @@index([status])
  @@index([hiringMode])
  @@index([expiryDate])
}
