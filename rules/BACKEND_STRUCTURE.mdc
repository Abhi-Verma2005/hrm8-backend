---
alwaysApply: true
---

# Backend Architecture & Code Structure (Manual Documentation)

> **Manual Reference File**: This file is maintained by the developer. Cursor AI will update `BACKEND_STRUCTURE.md` and notify you to update this file.

This file serves as your reference copy of the backend structure. When Cursor updates `BACKEND_STRUCTURE.md` after significant changes, review the changes and update this file accordingly.

## How This Works

1. Cursor AI will update `BACKEND_STRUCTURE.md` when it makes significant architectural changes
2. Cursor will notify you: "Please update `BACKEND_STRUCTURE.mdc` based on the changes in `BACKEND_STRUCTURE.md`"
3. You review the changes and update this `.mdc` file to match

---

## Architecture Overview

The backend follows a **layered architecture** pattern with clear separation of concerns:

```
Routes → Controllers → Services → Models → Database (Prisma)
         ↓              ↓          ↓
      Validators    Middleware   Utils
```

### Layer Responsibilities

1. **Routes** (`src/routes/`): Define HTTP endpoints and middleware chain
2. **Controllers** (`src/controllers/`): Handle HTTP requests/responses, delegate to services
3. **Services** (`src/services/`): Business logic layer
4. **Models** (`src/models/`): Data access layer (Prisma abstraction)
5. **Database**: PostgreSQL via Prisma ORM

## Directory Structure

```
backend/
├── src/
│   ├── server.ts              # Express app entry point
│   ├── routes/                # Route definitions
│   │   ├── index.ts           # Main router (combines all routes)
│   │   ├── auth.ts
│   │   ├── company.ts
│   │   ├── employee.ts
│   │   ├── job.ts
│   │   └── signupRequest.ts
│   ├── controllers/           # HTTP request handlers
│   │   ├── auth/
│   │   │   └── AuthController.ts
│   │   ├── company/
│   │   │   └── CompanyController.ts
│   │   ├── employee/
│   │   │   └── EmployeeController.ts
│   │   ├── job/
│   │   │   ├── JobController.ts
│   │   │   ├── ApplicationFormController.ts
│   │   │   └── JobDocumentController.ts
│   │   └── signupRequest/
│   │       └── SignupRequestController.ts
│   ├── services/              # Business logic
│   │   ├── auth/
│   │   │   └── AuthService.ts
│   │   ├── company/
│   │   │   ├── CompanyService.ts
│   │   │   └── CompanyProfileService.ts
│   │   ├── invitation/
│   │   │   └── InvitationService.ts
│   │   ├── verification/
│   │   │   └── VerificationService.ts
│   │   ├── job/
│   │   │   ├── JobService.ts
│   │   │   └── HiringTeamInvitationService.ts
│   │   ├── signupRequest/
│   │   │   └── SignupRequestService.ts
│   │   ├── ai/
│   │   │   ├── JobDescriptionExtractorService.ts
│   │   │   ├── JobDescriptionGeneratorService.ts
│   │   │   └── QuestionGenerationService.ts
│   │   ├── document/
│   │   │   └── DocumentParserService.ts
│   │   ├── email/
│   │   │   └── EmailService.ts
│   │   └── rbac/
│   │       ├── PermissionService.ts
│   │       └── RoleService.ts
│   ├── models/                # Data access layer
│   │   ├── User.ts
│   │   ├── Company.ts
│   │   ├── CompanyProfile.ts
│   │   ├── Session.ts
│   │   ├── Invitation.ts
│   │   ├── Job.ts
│   │   ├── SignupRequest.ts
│   │   └── VerificationToken.ts
│   ├── middleware/            # Express middleware
│   │   ├── auth.ts            # Authentication middleware
│   │   └── companyIsolation.ts # Company data isolation
│   ├── validators/            # Request validation middleware
│   │   ├── auth.ts
│   │   └── companyProfile.ts
│   ├── constants/             # Application constants
│   │   └── companyProfile.ts
│   ├── utils/                 # Pure utility functions
│   │   ├── email.ts
│   │   ├── password.ts
│   │   ├── domain.ts
│   │   ├── session.ts
│   │   └── token.ts
│   ├── types/                 # TypeScript type definitions
│   │   └── index.ts
│   ├── config/                # Configuration files
│   │   └── session.ts
│   └── lib/                   # Library setup
│       └── prisma.ts          # Prisma client singleton
├── prisma/
│   └── schema.prisma          # Database schema
└── dist/                      # Compiled JavaScript (generated)

```

## Code Patterns

### 1. Models (Data Access Layer)

**Pattern**: Static class with static methods for database operations

**Key Points**:
- All methods are `static`
- Methods return domain types (from `types/index.ts`), not Prisma types
- Private mapping methods convert Prisma → Domain types
- Handle Prisma-specific errors (e.g., unique constraint violations)
- Custom errors extend `Error` (e.g., `CompanyAlreadyExistsError`)

### 2. Services (Business Logic)

**Pattern**: Static class with static methods containing business logic

**Key Points**:
- Use `Model` classes for database access
- Use `utils/` functions for pure operations
- Return either success data or error objects
- Don't throw errors - return error objects for controllers to handle
- Services don't know about HTTP (no req/res)

### 3. Controllers (HTTP Layer)

**Pattern**: Static class with static async methods handling HTTP

**Key Points**:
- Methods return `Promise<void>` (use `res.json()` instead of return)
- Always use try-catch
- Standard response format: `{ success: boolean, data?: any, error?: string, errors?: string[] }`
- Check for error objects from services
- Handle specific error types (e.g., `CompanyAlreadyExistsError`)
- Set cookies for session management

### 4. Routes

**Pattern**: Express router with middleware chain

**Key Points**:
- Import controllers and middleware
- Apply validators before controllers
- Apply auth middleware for protected routes
- Export default router

### 5. Middleware

**Pattern**: Express middleware functions

**Key Points**:
- Use `AuthenticatedRequest` type for authenticated routes
- Attach data to `req` object (e.g., `req.user`, `req.companyScope`)
- Call `next()` on success, send response on error
- Don't proceed on error (return early)

### 6. Validators

**Pattern**: Express middleware validating request data

**Key Points**:
- Validate request body/params/query
- Collect all errors in array
- Return 400 with errors array if validation fails
- Call `next()` if validation passes

### 7. Utils

**Pattern**: Pure functions (no side effects)

**Key Points**:
- Pure functions only
- No dependencies on models/services/controllers
- Reusable across layers
- Well-documented with JSDoc

## Type System

### Domain Types (`src/types/index.ts`)

- Define interfaces matching Prisma schema
- Re-export Prisma enums for convenience
- Define request/response DTOs
- Define middleware context types (`AuthenticatedRequest`, `CompanyContext`)

## Authentication Flow

1. User sends credentials → `/api/auth/login`
2. Controller calls `AuthService.login()`
3. Service validates credentials using `UserModel`
4. On success, create session via `SessionModel.create()`
5. Set HTTP-only cookie with session ID
6. Subsequent requests include cookie
7. `authenticate` middleware validates session
8. Attach user to `req.user`

## Recent Auth Enhancements

- `/api/auth/login` now includes structured `details.code` values (e.g., `PENDING_VERIFICATION`, `INVALID_CREDENTIALS`, `ACCOUNT_INACTIVE`) so clients can respond contextually instead of string-matching.
- New `/api/auth/resend-verification` endpoint validates the email, ensures the admin is still `PENDING_VERIFICATION`, and reissues a 24h token while returning metadata (`email`, `companyId`, `expiresAt`) for UI messaging.
- `VerificationService.resendVerificationEmail` reuses `initiateEmailVerification`, centralizing the email delivery + token persistence flow and throwing typed errors with HTTP status hints for the controller.
- Validators now include `validateResendVerification`, which protects the resend endpoint from malformed payloads before it reaches the controller.


## Company Isolation

All company-scoped operations must:
1. Use `enforceCompanyIsolation` middleware (validates params/body match user's company)
2. Use `scopeToCompany` middleware (adds `req.companyScope` for queries)
3. Never allow cross-company data access

## Response Format

**Success Response**:
```json
{
  "success": true,
  "data": { ... }
}
```

**Error Response**:
```json
{
  "success": false,
  "error": "Error message",
  "errors": ["Validation error 1", "Validation error 2"]
}
```

## Error Handling

1. **Validation Errors**: Return 400 with `errors` array
2. **Authentication Errors**: Return 401
3. **Authorization Errors**: Return 403
4. **Not Found Errors**: Return 404
5. **Business Logic Errors**: Return appropriate 4xx status
6. **Server Errors**: Return 500 with generic message (detailed in dev mode)

## Database Access

- **Always use Models**: Never use Prisma client directly in Services/Controllers
- **Prisma Client**: Only in Models and `lib/prisma.ts` (singleton)
- **Transactions**: Use Prisma transactions in Models when needed
- **Migrations**: Use `pnpm db:migrate` for schema changes

## Code Style

1. **JSDoc Comments**: All public methods must have JSDoc
2. **File Headers**: Each file should have a descriptive header comment
3. **Exports**: Use named exports for classes, default exports for routes
4. **Async/Await**: Always use async/await (no promises chains)
5. **Type Safety**: Use TypeScript strictly, avoid `any`
6. **Error Objects**: Return error objects from services instead of throwing

## Job Management

The job management system includes:

### Controllers
- **JobController**: Handles CRUD operations for job postings, publishing, templates
- **ApplicationFormController**: Manages application form configuration and question generation
- **JobDocumentController**: Handles document parsing for job description extraction

### Services
- **JobService**: Core business logic for job management
- **HiringTeamInvitationService**: Manages hiring team member invitations
- **JobDescriptionExtractorService**: AI-powered extraction from documents
- **JobDescriptionGeneratorService**: AI-powered job description generation
- **QuestionGenerationService**: AI-powered application form question generation

### Models
- **Job**: Represents job postings with status, hiring mode, work arrangement, etc.

### Job Status Enum
- `DRAFT`: Job is being created/edited
- `OPEN`: Job is published and accepting applications
- `CLOSED`: Job is no longer accepting applications
- `ON_HOLD`: Job posting is temporarily paused
- `FILLED`: Position has been filled
- `CANCELLED`: Job posting was cancelled
- `TEMPLATE`: Saved as a template for reuse

## AI Services

AI-powered services for job management:

- **JobDescriptionExtractorService**: Extracts job details from uploaded documents (PDF, DOCX, TXT)
- **JobDescriptionGeneratorService**: Generates job descriptions using AI based on form fields
- **QuestionGenerationService**: Generates application form questions using AI

All AI services fall back to pattern matching if OpenAI API is unavailable.

## RBAC (Role-Based Access Control)

### Services
- **RoleService**: Manages user role assignments
- **PermissionService**: Handles permission checks

### User Roles
- `SUPER_ADMIN`: Full system access
- `ADMIN`: Company-level admin access
- `USER`: Standard employee access
- `VISITOR`: Limited read-only access

### Middleware
- `requireAdmin`: Requires SUPER_ADMIN or ADMIN role
- `requireSuperAdmin`: Requires SUPER_ADMIN role
- `requireJobPostingPermission`: Requires SUPER_ADMIN or ADMIN role (for job operations)

## Company Profile & Onboarding

### Services
- **CompanyProfileService**: Manages company onboarding profile lifecycle

### Models
- **CompanyProfile**: Stores onboarding profile data with sections (basic details, location, personal profile, team members, billing, branding)

### Profile Sections
- `BASIC_DETAILS`: Company name, size, industry, contact info
- `PRIMARY_LOCATION`: Main office location
- `PERSONAL_PROFILE`: Company description, values, culture
- `TEAM_MEMBERS`: Team member invitations
- `BILLING`: Payment preferences and accounts email
- `BRANDING`: Logo, colors, subdomain

## Document Processing

### Services
- **DocumentParserService**: Parses PDF, DOCX, and TXT files
  - Extracts text content
  - Provides metadata (pages, word count, etc.)
  - Used for job description extraction

## Notes

_Add your own notes and observations here as you work with the codebase._

### Known Issues (2025-01-27)
- Services are throwing errors instead of returning error objects (pattern violation)
- Controllers have redundant authentication checks (duplication)
- Validation logic duplicated in controllers instead of validators
- Error response formatting not centralized
